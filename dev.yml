services:
  # This is a static version of the dev environment, in case you're not interested
  # in changing the codebase but just running.
  # Note:
  # > Next.js will replace process.env.customKey with 'my-value' at build time.
  # https://nextjs.org/docs/app/api-reference/next-config-js/env
  app-static:
    build:
      context: .
      dockerfile_inline: |
        FROM node:22-alpine3.22
        COPY . /build/src/
        WORKDIR /build/src
        RUN npm install
        RUN npm run build
        ENTRYPOINT npm run start -p 3000
    profiles: [static]
    env_file:
      - path: ./.env.development
    ports:
      - 3000
    network_mode: host

  # With this version of the app, npm will install dependencies every time you start
  # the container. So it's a bit slower to start, which may be annoying if you're only
  # developing the backend (Zetkin Platform)
  app-dev:
    build:
      context: .
      dockerfile_inline: |
        FROM node:22-alpine3.22
        WORKDIR /repo
        ENTRYPOINT npm install && npm run devserver
    profiles: [dev]
    ports:
      - 3000
    volumes:
      - ./:/repo
    network_mode: host

  # WIP: It's possible to run the precommit hook from within a container
  # docker compose -f dev.yml run lint
  # docker compose -f dev.yml run lint npx prettier . --check
  lint:
    build:
      context: .
      dockerfile_inline: |
        FROM node:22-alpine3.22
        USER node
        WORKDIR /repo
        RUN npm install
    profiles: [lint]
    user: node
    tty: true
    working_dir: /repo
    volumes:
      - ./:/repo
    command: sh .githooks/pre-commit
